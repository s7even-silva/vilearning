<div class="lab-workspace">
  <div class="lab-header">
    <div class="header-title">
      <span class="lab-badge">EN VIVO</span>
      <h2>Laboratorio Activo</h2>
    </div>
    <div class="header-actions">
      <button class="btn-finish" (click)="finishLab()">Finalizar Laboratorio</button>
    </div>
  </div>

  <div class="workspace-grid">

    <!-- Panel de c√°mara con overlay -->
    <div class="camera-panel panel-card">
      <div class="panel-header">
        <span class="panel-number">1</span>
        <h3>Detecci√≥n de Mano</h3>
      </div>
      <div class="camera-container">
        <!-- Video y Canvas overlay con aspect ratio -->
        <div class="video-wrapper">
          <!-- Video oculto - MediaPipe lo usa como fuente -->
          <video
            #video
            style="display: none"
            width="640"
            height="480"
            autoplay>
          </video>

          <!-- Canvas overlay para dibujar la detecci√≥n -->
          <canvas
            #canvas
            width="640"
            height="480"
            class="overlay-canvas">
          </canvas>
        </div>

        <!-- Estado de la detecci√≥n -->
        <div class="detection-status" [class.active]="detectionState.handDetected">
          <span class="status-indicator" [class.active]="detectionState.handDetected"></span>
          @if (detectionState.handDetected) {
            <span class="status-text">Mano detectada</span>
          } @else {
            <span class="status-text">Esperando mano...</span>
          }
        </div>
      </div>
    </div>

    <!-- Panel de visualizaci√≥n de la pr√≥tesis (C√°mara USB) -->
    <div class="hand-visualization-panel panel-card">
      <div class="panel-header">
        <span class="panel-number">2</span>
        <h3>Pr√≥tesis en Tiempo Real</h3>
      </div>
      <div class="usb-camera-container">
        <!-- Stream de la c√°mara USB -->
        <div class="camera-stream-wrapper">
          @if (!cameraStreamState.hasError) {
            <img
              #usbCamera
              [src]="cameraStreamState.url"
              alt="Vista de la pr√≥tesis"
              class="usb-camera-stream"
              (load)="onCameraLoad()"
              (error)="onCameraError()"
            />
          }

          <!-- Estado de carga -->
          @if (!cameraStreamState.isLoaded && !cameraStreamState.hasError) {
            <div class="camera-status loading">
              <div class="spinner"></div>
              <p>Conectando con la pr√≥tesis...</p>
            </div>
          }

          <!-- Estado de error -->
          @if (cameraStreamState.hasError) {
            <div class="camera-status error">
              <div class="error-icon">‚ö†</div>
              <p>{{ cameraStreamState.errorMessage || 'No se pudo conectar con la pr√≥tesis' }}</p>
              <button class="btn-retry" (click)="retryCameraStream()">
                Reintentar Conexi√≥n
              </button>
            </div>
          }

          <!-- Indicador de stream activo -->
          @if (cameraStreamState.isLoaded) {
            <div class="stream-indicator">
              <span class="live-badge">
                <span class="live-dot"></span>
                EN VIVO
              </span>
            </div>
          }
        </div>

        <!-- Gesto detectado -->
        <div class="gesture-display">
          <h4>Gesto Reconocido</h4>
          <p class="gesture-text">{{ detectionState.currentGesture }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel de estado de dedos -->
  <div class="finger-status-panel panel-card">
    <div class="panel-header">
      <span class="panel-number">3</span>
      <h3>Estado de los Dedos</h3>
    </div>
    <div class="finger-grid">
      <div class="finger-item" [class.active]="detectionState.fingerStates.thumb">
        <div class="finger-indicator" [class.active]="detectionState.fingerStates.thumb">
          <span class="finger-icon">üëç</span>
        </div>
        <span class="finger-label">Pulgar</span>
        <span class="finger-state">{{ detectionState.fingerStates.thumb ? 'Extendido' : 'Contra√≠do' }}</span>
      </div>
      <div class="finger-item" [class.active]="detectionState.fingerStates.index">
        <div class="finger-indicator" [class.active]="detectionState.fingerStates.index">
          <span class="finger-icon">‚òù</span>
        </div>
        <span class="finger-label">√çndice</span>
        <span class="finger-state">{{ detectionState.fingerStates.index ? 'Extendido' : 'Contra√≠do' }}</span>
      </div>
      <div class="finger-item" [class.active]="detectionState.fingerStates.middle">
        <div class="finger-indicator" [class.active]="detectionState.fingerStates.middle">
          <span class="finger-icon">üñï</span>
        </div>
        <span class="finger-label">Medio</span>
        <span class="finger-state">{{ detectionState.fingerStates.middle ? 'Extendido' : 'Contra√≠do' }}</span>
      </div>
      <div class="finger-item" [class.active]="detectionState.fingerStates.ring">
        <div class="finger-indicator" [class.active]="detectionState.fingerStates.ring">
          <span class="finger-icon">üíç</span>
        </div>
        <span class="finger-label">Anular</span>
        <span class="finger-state">{{ detectionState.fingerStates.ring ? 'Extendido' : 'Contra√≠do' }}</span>
      </div>
      <div class="finger-item" [class.active]="detectionState.fingerStates.pinky">
        <div class="finger-indicator" [class.active]="detectionState.fingerStates.pinky">
          <span class="finger-icon">ü§ô</span>
        </div>
        <span class="finger-label">Me√±ique</span>
        <span class="finger-state">{{ detectionState.fingerStates.pinky ? 'Extendido' : 'Contra√≠do' }}</span>
      </div>
    </div>
  </div>
</div>
